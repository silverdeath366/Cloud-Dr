# n8n Workflows

This directory contains n8n workflows for CloudPhoenix incident intelligence and automation.

**Note**: These workflows are built manually in the n8n interface and are not auto-generated by Cursor.

## ðŸ“š Documentation

- **[Intelligent DR Setup Guide](./INTELLIGENT-DR-SETUP-GUIDE.md)** - Complete step-by-step guide for building the LLM-powered DR decision workflow
- **[Quick Reference](./QUICK-REFERENCE.md)** - Quick cheat sheet for building the workflow

## Workflows

### ðŸŽ¯ 1. Intelligent DR Decision Workflow (Main Workflow)

**Status**: Ready for manual setup  
**Guide**: See [INTELLIGENT-DR-SETUP-GUIDE.md](./INTELLIGENT-DR-SETUP-GUIDE.md)

- **Trigger**: Webhook from Prometheus/Health Check when health score > 11
- **Purpose**: Use LLM to determine if issue is AWS/Cloudflare infrastructure vs. internal bug
- **Actions**:
  - Gather context from AWS, Cloudflare, Prometheus, Loki
  - Send to LLM (GPT-4/Claude) for analysis
  - Only trigger DR if LLM determines it's external infrastructure issue
  - Log decisions and reasoning
  
**Key Features**:
- âœ… Intelligent decision-making with LLM
- âœ… Only triggers DR for external infrastructure issues
- âœ… Prevents false positives from internal bugs
- âœ… Comprehensive context gathering
- âœ… Audit logging of all decisions

### 2. DR Webhook Receiver
- **Trigger**: Webhook from Jenkins pipeline
- **Purpose**: Receive DR failover notifications
- **Actions**:
  - Log incident
  - Trigger notifications
  - Start incident tracking

### 3. Log Aggregator â†’ LLM Summarizer
- **Trigger**: Scheduled or webhook
- **Purpose**: Aggregate logs and generate summaries
- **Actions**:
  - Collect logs from Loki
  - Send to LLM for analysis
  - Generate incident summary

### 4. Root Cause Generator
- **Trigger**: Post-incident
- **Purpose**: Analyze incident and suggest root causes
- **Actions**:
  - Analyze metrics
  - Review logs
  - Generate root cause analysis

### 5. Slack + Jira Integration
- **Trigger**: Incident detected
- **Purpose**: Notify team and create tickets
- **Actions**:
  - Send Slack notifications
  - Create Jira tickets
  - Update status pages

### 6. Post-Incident Report Generator
- **Trigger**: After incident resolution
- **Purpose**: Generate postmortem reports
- **Actions**:
  - Collect incident data
  - Generate report using LLM
  - Distribute to stakeholders

## ðŸš€ Quick Start

### Build the Intelligent DR Decision Workflow

1. **Read the Guide**: Start with [INTELLIGENT-DR-SETUP-GUIDE.md](./INTELLIGENT-DR-SETUP-GUIDE.md)
2. **Prepare Environment**:
   - Install n8n (cloud or self-hosted)
   - Get OpenAI or Anthropic API key
   - Configure AWS credentials (optional)
   - Ensure Prometheus/Loki are accessible
3. **Build Workflow**: Follow step-by-step instructions in the guide
4. **Test**: Use test scenarios provided in guide
5. **Deploy**: Enable workflow and configure Prometheus alerts

### Required Scripts

- âœ… `scripts/gather_incident_context.py` - Gathers all context for LLM
- âœ… `scripts/healthcheck.py` - Health check script
- âœ… `scripts/trigger_dr.sh` - DR trigger script

## Setup Instructions

1. Read [INTELLIGENT-DR-SETUP-GUIDE.md](./INTELLIGENT-DR-SETUP-GUIDE.md) for main workflow
2. Import other workflows into n8n (if available)
3. Configure webhook URLs
4. Set up API keys for:
   - LLM service (OpenAI/Anthropic)
   - AWS (optional, for Health API)
   - Jenkins
   - Slack
   - Jira
   - Loki
5. Test workflows
6. Enable production

## Webhook Endpoints

### For Intelligent DR Workflow
- `/intelligent-dr-check` - Main trigger endpoint (from Prometheus/Health Check)

### Other Workflows
- `/dr-started` - DR failover started
- `/dr-completed` - DR failover completed
- `/incident-detected` - Incident detected
- `/incident-resolved` - Incident resolved

## ðŸ“– Learning Resources

- **n8n Documentation**: https://docs.n8n.io/
- **OpenAI API Docs**: https://platform.openai.com/docs
- **Anthropic API Docs**: https://docs.anthropic.com/
- **AWS Health API**: https://docs.aws.amazon.com/health/
- **Cloudflare Status API**: https://www.cloudflarestatus.com/api

